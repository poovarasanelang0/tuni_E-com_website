import React, { useState, useEffect } from "react";
import { useParams, Link, useNavigate } from "react-router-dom";
import Slider from "react-slick";
import Header from "../../Compoment/Header/Header";
import Footer from "../../Compoment/Footer/Footer";
import DisImg from "./Assets/trust_banner_2.svg";
import "./SingleProduct.css";
import Addedeimg from "./Assets/NewImagesJoggers-0011.webp";
import Product_add from "./Product_add";
import Gpaypayment from "./Assets/secure-transaction.svg";
import Devlimg from "./Assets/delivery-sec.svg";
import { doc, getDoc, getDocs } from "firebase/firestore";
import { firestore } from "../../firebaseConfig";
import SaleTimeRuning from "./SaleTimeRuning";
import {
  collection,
  addDoc,
  getFirestore,
  deleteDoc,
  updateDoc,
} from "firebase/firestore";
import Payment from "../Payment/Payment";

const SingleProduct = () => {
  const settings = {
    customPaging: function (i) {
      return (
        <a>
          <img
            src={productDetails.imageUrl[i]}
            alt={`View ${i + 1}`}
            className="img-fluid"
          />
        </a>
      );
    },
    dots: true,
    dotsClass: "slick-dots slick-thumb",
    infinite: true,
    speed: 500,
    slidesToShow: 1,
    slidesToScroll: 1,
  };
  const navigate = useNavigate();
  const [showCart, setShowCart] = useState(false);
  const [countDown, setCountDown] = useState("");
  const [selectedSize, setSelectedSize] = useState(null);
  const [cart, setCart] = useState([]);
  const { productId } = useParams();
  const [productDetails, setProductDetails] = useState(null);

  const handleQuantityChange = async (productId, newQuantity) => {
    try {
      const firestore = getFirestore();
      const cartCollectionRef = collection(firestore, "addtocart");
      const querySnapshot = await getDocs(cartCollectionRef);

      querySnapshot.forEach(async (doc) => {
        const subCollectionRef = collection(doc.ref, "products");
        const subCollectionSnapshot = await getDocs(subCollectionRef);

        subCollectionSnapshot.forEach(async (subDoc) => {
          if (subDoc.id === productId) {
            // Update the document's itemCountcustomer field
            await updateDoc(subDoc.ref, { itemCountcustomer: newQuantity });
            console.log("Item count updated successfully!");
          }
        });
      });
    } catch (error) {
      console.error("Error updating item count:", error);
    }
  };

  useEffect(() => {
    const fetchProductDetails = async () => {
      try {
        const paths = [
          ["clothes", "Men", "Tshirt", "full sleve", "Plain"],
          ["clothes", "Men", "Tshirt", "full sleve", "Printed"],
          ["clothes", "Men", "Tshirt", "half sleve", "Plain"],
          ["clothes", "Men", "Tshirt", "half sleve", "Printed"],
          ["clothes", "Men", "Shirt", "half sleve", "Plain"],
          ["clothes", "Men", "Shirt", "half sleve", "Printed"],
          ["clothes", "Men", "Shirt", "full sleve", "Plain"],
          ["clothes", "Men", "Shirt", "full sleve", "Printed"],
          // Add more paths as needed
        ];

        for (const path of paths) {
          const productRef = doc(firestore, ...path, productId);
          const snapshot = await getDoc(productRef);

          if (snapshot.exists()) {
            const data = { ...snapshot.data(), id: snapshot.id };
            setProductDetails(data);
            return; // Exit the loop if product details are found
          }
        }

        console.log("Product not found");
      } catch (error) {
        console.error("Error fetching product details:", error);
      }
    };

    fetchProductDetails();
  }, [productId]);

  const handleSizeClick = (size) => {
    setSelectedSize(size);
  };

  // const handleAddToCart = async () => {
  //   try {
  //     // Check if a size has been selected
  //     if (!selectedSize) {
  //       console.error("Please select a size before adding to cart");
  //       return;
  //     }

  //     const firestore = getFirestore();
  //     const cartCollectionRef = collection(firestore, "addtocart");

  //     const newDocRef = await addDoc(cartCollectionRef, {});

  //     console.log("New document added to 'addtocart' with ID: ", newDocRef.id);

  //     const subCollectionRef = collection(newDocRef, "products");

  //     const productWithSize = {
  //       ...productDetails,
  //       size: selectedSize,
  //     };

  //     await addDoc(subCollectionRef, productWithSize);

  //     console.log("Product added to the new subcollection successfully!");

  //     fetchCartProducts();
  //   } catch (error) {
  //     console.error("Error adding product to cart: ", error);
  //   }
  // };

  // 3rd -----------------------------------------

  const handleAddToCart = async () => {
    try {
      if (!selectedSize) {
        console.error("Please select a size before adding to cart");
        return;
      }

      const firestore = getFirestore();
      const cartCollectionRef = collection(firestore, "addtocart");

      const newDocRef = await addDoc(cartCollectionRef, {});

      console.log("New document added to 'addtocart' with ID: ", newDocRef.id);

      const subCollectionRef = collection(newDocRef, "products");

      const productWithSizeAndCount = {
        ...productDetails,
        sizecustomers: selectedSize,
        itemCountcustomer: 1,
      };

      // Add the product data to the subcollection 'products'
      await addDoc(subCollectionRef, productWithSizeAndCount);

      console.log("Product added to the new subcollection successfully!");

      // Fetch and update the cart products
      fetchCartProducts();
    } catch (error) {
      console.error("Error adding product to cart: ", error);
    }
  };

  const [cartProducts, setCartProducts] = useState([]);

  // Fetch cart products
  const fetchCartProducts = async () => {
    try {
      const firestore = getFirestore();
      const cartCollectionRef = collection(firestore, "addtocart");
      const querySnapshot = await getDocs(cartCollectionRef);

      const promises = [];
      const cartProducts = [];

      querySnapshot.forEach((doc) => {
        const subCollectionRef = collection(doc.ref, "products");
        const promise = getDocs(subCollectionRef).then(
          (subCollectionSnapshot) => {
            subCollectionSnapshot.forEach((subDoc) => {
              const data = subDoc.data();
              cartProducts.push({
                id: subDoc.id,
                data: data,
              });
              console.log("data", data);
            });
          }
        );
        promises.push(promise);
      });

      await Promise.all(promises);
      setCartProducts(cartProducts);
      console.log("cartProducts....", cartProducts);
    } catch (error) {
      console.error("Error fetching cart products:", error);
    }
  };

  useEffect(() => {
    const fetchProductDetails = async () => {
      try {
        const firestore = getFirestore();
        const productRef = collection(firestore, "products");
        const productSnapshot = await getDocs(productRef);
        const product = productSnapshot.docs.find(
          (doc) => doc.id === productId
        );

        if (product.exists()) {
          const data = { ...product.data(), id: product.id };
          setProductDetails(data);
        } else {
          console.log("Product not found");
        }
      } catch (error) {
        console.error("Error fetching product details:", error);
      }
    };

    fetchProductDetails();
  }, [productId]);

  const handleRemoveFromCart = async (productId) => {
    try {
      const firestore = getFirestore();
      const cartCollectionRef = collection(firestore, "addtocart");
      const querySnapshot = await getDocs(cartCollectionRef);

      querySnapshot.forEach(async (doc) => {
        const subCollectionRef = collection(doc.ref, "products");
        const subCollectionSnapshot = await getDocs(subCollectionRef);

        subCollectionSnapshot.forEach((subDoc) => {
          if (subDoc.id === productId) {
            // Delete the document from the subcollection
            deleteDoc(subDoc.ref)
              .then(() => {
                console.log("Document successfully deleted from cart!");
                // Fetch and display the updated cart products
                fetchCartProducts();
              })
              .catch((error) => {
                console.error("Error removing document: ", error);
              });
          }
        });
      });
    } catch (error) {
      console.error("Error removing product from cart: ", error);
    }
  };

  const calculateTotalPrice = (cartProducts) => {
    let totalPrice = 0;
    cartProducts.forEach((cartProduct) => {
      totalPrice += parseInt(cartProduct.data.price);
    });
    return totalPrice;
  };

  const totalCartPrice = calculateTotalPrice(cartProducts);

  if (!productDetails) {
    return <p>Loading...</p>;
  }

  return (
    <>
      <Header />
      <div className="container my-5 fontfamily">
        <div className="row">
          <div className="col-lg-6 col-md-12 col-12">
            <div className="slider-container">
              <Slider {...settings}>
                {productDetails.imageUrl.map((imageUrl, index) => (
                  <div key={index} className="single_img">
                    <img
                      src={imageUrl}
                      alt={`View ${index + 1}`}
                      className="img-fluid"
                    />
                  </div>
                ))}
              </Slider>
            </div>
          </div>
          <div className="col-lg-6 col-md-12 col-12">
            <div className="product-details py-1 my-4">
              <h2>{productDetails.name}</h2>
              <p>
                Description of the product goes here. You can provide all the
                details about the product, its features, specifications, etc.
              </p>
              <div className="product-price">
                <p>
                  <i className="bi bi-currency-rupee text_color_heading fs-3">
                    {productDetails.price}
                  </i>
                  {"\u00a0"}
                  {"\u00a0"}
                  {"\u00a0"}
                  <del className="text-muted fs-5">
                    {" "}
                    <i className="bi bi-currency-rupee"></i>2045
                  </del>
                  {"\u00a0"}
                  {"\u00a0"}
                  {"\u00a0"}
                  <span class="badge rounded-pill px-3 py-2 text_color_heading_back">
                    Save 10%
                  </span>
                </p>
                <div className="ms-auto">
                  <span class="badge rounded-pill bg-light text-dark card-text py-2 px-3 fs-5">
                    <i class="bi bi-star-fill text-warning"></i> 4.5 | 20
                  </span>
                </div>
                <p className="text-muted font_size_tax mt-4">
                  Tax included. Shipping calculated at checkout
                </p>
                <p className="text-danger font_size_bought">
                  <i class="bi bi-cart-check-fill">{"\u00a0"}</i>455 people
                  bought this in last 7 days
                </p>
                <div className="bg_sales_end">
                  <SaleTimeRuning />
                </div>

                <h3 className="fw-bold">Select Size</h3>
                <div className="d-flex my-3">
                  {productDetails && (
                    <>
                      {productDetails.size.includes("S") && (
                        <button
                          type="button"
                          className={`btn btn-outline-primary rounded-pill mx-3 ${
                            selectedSize === "S" ? "active" : ""
                          }`}
                          onClick={() => handleSizeClick("S")}
                        >
                          S
                        </button>
                      )}
                      {productDetails.size.includes("M") && (
                        <button
                          type="button"
                          className={`btn btn-outline-primary rounded-pill mx-3 ${
                            selectedSize === "M" ? "active" : ""
                          }`}
                          onClick={() => handleSizeClick("M")}
                        >
                          M
                        </button>
                      )}
                      {productDetails.size.includes("L") && (
                        <button
                          type="button"
                          className={`btn btn-outline-primary rounded-pill mx-3 ${
                            selectedSize === "L" ? "active" : ""
                          }`}
                          onClick={() => handleSizeClick("L")}
                        >
                          L
                        </button>
                      )}
                      {productDetails.size.includes("XL") && (
                        <button
                          type="button"
                          className={`btn btn-outline-primary rounded-pill mx-3 ${
                            selectedSize === "XL" ? "active" : ""
                          }`}
                          onClick={() => handleSizeClick("XL")}
                        >
                          XL
                        </button>
                      )}
                      {productDetails.size.includes("XS") && (
                        <button
                          type="button"
                          className={`btn btn-outline-primary rounded-pill mx-3 ${
                            selectedSize === "XS" ? "active" : ""
                          }`}
                          onClick={() => handleSizeClick("XS")}
                        >
                          XS
                        </button>
                      )}
                      {productDetails.size.includes("XXL") && (
                        <button
                          type="button"
                          className={`btn btn-outline-primary rounded-pill mx-3 ${
                            selectedSize === "XXL" ? "active" : ""
                          }`}
                          onClick={() => handleSizeClick("XXL")}
                        >
                          XXL
                        </button>
                      )}
                    </>
                  )}
                </div>

                <div className="text-center my-3">
                  {selectedSize ? (
                    <button
                      className="background_color_name px-5 mx-5 py-2 border-0 rounded-pill text-white"
                      onClick={handleAddToCart}
                      data-bs-toggle="offcanvas"
                      data-bs-target="#offcanvasRightADDCARD"
                      aria-controls="offcanvasRightADDCARD"
                    >
                      Add to Cart
                    </button>
                  ) : (
                    <p className="text-danger">Please select size</p>
                  )}
                </div>

                <div className="">
                  <img src={DisImg} alt="" className="img-fluid img_size" />
                </div>
              </div>

              {/* offcanva */}

              {/* This added to cart show */}
              <div
                className={`offcanvas offcanvas-end ${showCart ? "show" : ""}`}
                tabIndex="-1"
                id="offcanvasRightADDCARD"
                aria-labelledby="offcanvasRightLabel"
              >
                <div className="offcanvas-header">
                  <h5 className="fw-bold">Shopping Cart</h5>
                  <button
                    type="button"
                    className="btn-close text-reset"
                    data-bs-dismiss="offcanvas"
                    aria-label="Close"
                  ></button>
                </div>
                <div className="offcanvas-body overflow-y-auto">
                  <div>
                    {cartProducts.map((cartProduct) => (
                      <div className="map_function" key={cartProduct.id}>
                        <div className="row align-items-center">
                          <div className="col-md-4">
                            <div className="addecardimg text-center">
                              <img
                                src={cartProduct.data.imageUrl}
                                alt="Addedeimg"
                                className="img-fluid"
                              />
                            </div>
                          </div>
                          <div className="col-md-8">
                            <div>
                              <h6 className="fw-bold">
                                {cartProduct.data.name}
                              </h6>
                              <div className="d-flex align-items-center">
                                <i className="bi bi-currency-rupee fw-bold">
                                  {cartProduct.data.price}
                                </i>{" "}
                                {"\u00a0"}
                                {"\u00a0"}
                                <span className="Success_color fw-bold fs-5">
                                  OFF
                                </span>
                              </div>
                              <h6 className="fw-bold">
                                <span className="text-secondary">Color :</span>{" "}
                                {cartProduct.data.color}
                              </h6>
                              <h6 className="fw-bold">
                                <span className="text-secondary">Size :</span>{" "}
                                {cartProduct.data.sizecustomers}
                              </h6>
                              <p className="Success_color">
                                Lowest price in last 30 days
                              </p>
                              <div className="d-flex justify-content-between align-items-center">
                                <div style={{ marginTop: "-13px" }}>
                                  <p className="text-muted">Quantity:</p>
                                  <Product_add
                                    initialQuantity={1} // Set initial quantity to 1
                                    onQuantityChange={(newQuantity) =>
                                      handleQuantityChange(
                                        cartProduct.id,
                                        newQuantity
                                      )
                                    }
                                  />
                                </div>
                                <p className="fs-1">{cartProduct.data.itemCountcustomer}</p>
                                <div
                                  className="font_size"
                                  style={{ marginTop: "10px" }}
                                >
                                  <button
                                    className="btn btn-link border-0 fw-bold px-3 py-1  rounded-pill"
                                    onClick={() =>
                                      handleRemoveFromCart(cartProduct.id)
                                    }
                                  >
                                    Remove
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>

                  <div className="col">
                    <img
                      src={Gpaypayment}
                      alt="Gpaypayment"
                      className="img-fluid"
                    />
                  </div>

                  <div className="col">
                    <h4 className="fw-bold">Order Summary :</h4>
                    <div className="d-flex justify-content-between">
                      <div>
                        <p>Total MRP</p>
                        <p>Bag Discount</p>
                        <p>Coupon Discount</p>
                        <p>Shipping Charge</p>
                      </div>

                      <div>
                        <p>
                          <i className="bi bi-currency-rupee"></i>
                          {totalCartPrice}
                        </p>
                        <p>
                          -<i className="bi bi-currency-rupee"></i>100
                        </p>
                        <p>
                          <i className="bi bi-currency-rupee"></i>0.00
                        </p>
                        <p className="text-success fw-bold">Free</p>
                      </div>
                    </div>
                    <hr />
                    <div className="d-flex justify-content-between">
                      <div>
                        <h5 className="fw-bold">Total Payable </h5>
                      </div>
                      <div>
                        <h5 className="fw-bold">
                          <i className="bi bi-currency-rupee"></i>
                          {totalCartPrice}
                        </h5>
                      </div>
                    </div>
                  </div>
                  <div className="col my-4">
                    <img src={Devlimg} alt="Devlimg" className="img-fluid" />
                  </div>
                  {/* Sticky Footer for Shopping Cart */}
                  <div className="sticky-bottom bg-light p-3  shadow-lg rounded-pill w-100">
                    <Payment cartProducts={cartProducts} />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <Footer />
    </>
  );
};

export default SingleProduct;





























------------------------------------------------------------------
import React, { useState,useEffect } from "react";
import "./LoginSignup.css";
import LoginSignupImg from "./assets/small.png";
import fotterimg1 from "./assets/corousal_icon_filled.svg";
import Google from "./assets/google.png";
import { Link } from "react-router-dom";
import OtpForm from "./OtpForm";

import "react-phone-number-input/style.css";
import PhoneInput from "react-phone-number-input";

import { auth } from "../../firebaseConfig";

import { RecaptchaVerifier, signInWithPhoneNumber } from "firebase/auth";

const Login = () => {
  const [showOTPForm, setShowOTPForm] = useState(false);
  const [phoneNumber, setPhoneNumber] = useState("");
  const [verificationCode, setVerificationCode] = useState("");
  const [confirmationResult, setConfirmationResult] = useState(null);
  const [error, setError] = useState("");
  const [previousPage, setPreviousPage] = useState("");

  const handleGoBack = () => {
    // If the previous page is "login", hide the OTP form and navigate back
    if (previousPage === "login") {
      setShowOTPForm(false);
    }
  };


  const handleSendOTP = async (e) => {
    e.preventDefault();
    try {
      const recaptcha = new RecaptchaVerifier(auth, "recaptcha-container");
      const confirmation = await signInWithPhoneNumber(auth, phoneNumber, recaptcha);
      setConfirmationResult(confirmation);
      setShowOTPForm(true);
      setPreviousPage("login");
    } catch (err) {
      console.log(err);
      setError(err.message);
    }
  };

  const handleVerifyOTP = async (otp) => {
    try {
      const userCredential = await confirmationResult.confirm(otp);
      console.log("verify login");
    } catch (err) {
      console.log(err);
      setError(err.message);
    }
  };



  const handleResendOTP = async () => {
    try {
      // Ensure phoneNumber is provided
      if (!phoneNumber) {
        setError("Please provide a phone number");
        return;
      }
  
      let recaptchaVerifier = null;
      const recaptchaContainer = document.getElementById("recaptcha-container");
      if (recaptchaContainer) {
        recaptchaVerifier = new RecaptchaVerifier(recaptchaContainer, {
          size: "invisible",
          callback: () => {
            // Callback function if needed
          },
        });
      } else {
        setError("Recaptcha container not found");
        console.log("error111");
        return;
      }
  
      // Clear any previous verification attempts
      setConfirmationResult(null);
  
      // Resend OTP
      const confirmation = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
      setConfirmationResult(confirmation);
      console.log("Resent OTP");
    } catch (err) {
      console.log(err);
      setError(err.message);
      console.log("error13333");

    }
  };
  

 

  return (
    <>
      <div className="container">
        <div className="row my-1">
          <div className="col-lg-7 col-md-12 col-12">
            <div className="login_image_logo text-center">
              <img src={LoginSignupImg} alt="" className="img-fluid" />
            </div>
            <div className="my-3">
              <p className="text-white fw-bold fs-5 text-center family_font">
                Join the TUNi Family for a delightful shopping experience
              </p>
            </div>
            <div className="row my-5">
              <div className="col-lg-4 col-md-6 col-sm-4 d-none d-md-block mb-3 d-flex">
                <div className="shadow_lg d-flex flex-column w-100">
                  <div className="text-center small_image">
                    <img src={fotterimg1} alt="" className="img-fluid my-3" />
                  </div>
                  <div className="py-2 flex-grow-1">
                    <p className="text-center heading_font text-white fw-bold">
                      Premium Quality Clothes
                    </p>
                    <p className="text-center text-white para_font">
                      Quality, comfort, and style – TUNi delivers on all fronts
                    </p>
                  </div>
                </div>
              </div>
              <div className="col-lg-4 col-md-6 col-sm-4 d-none d-md-block mb-3 d-flex">
                <div className="shadow_lg d-flex flex-column w-100">
                  <div className="text-center small_image">
                    <img src={fotterimg1} alt="" className="img-fluid my-3" />
                  </div>
                  <div className="py-2 flex-grow-1">
                    <p className="text-center heading_font text-white fw-bold">
                      Great Customer Experience
                    </p>
                    <p className="text-center text-white para_font">
                      For us customer experience comes first -TUNi
                    </p>
                  </div>
                </div>
              </div>
              <div className="col-lg-4 col-md-6 col-sm-4 d-none d-md-block mb-3 d-flex">
                <div className="shadow_lg d-flex flex-column w-100">
                  <div className="text-center small_image">
                    <img src={fotterimg1} alt="" className="img-fluid my-3" />
                  </div>
                  <div className="py-2 flex-grow-1">
                    <p className="text-center heading_font text-white fw-bold">
                      Best Team Behind Your Clothes
                    </p>
                    <p className="text-center text-white para_font">
                      We have the best talents to produce clothes you love
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {/* otp */}
          <div
            className="col-lg-5 col-md-12 col-12"
            style={{ background: "white", borderRadius: "10px" }}
          >
            <div className="my-1">
              {showOTPForm ? (
                <OtpForm handleVerifyOTP={handleVerifyOTP} handleResendOTP={handleResendOTP} phoneNumber={phoneNumber} handleGoBack={handleGoBack}/>
              ) : (
                <>
                  <h4 className="text-center fw-bold my-3 py-1">
                    Delighted to have you!
                  </h4>
                  <p className="text-center text-secondary py-1">
                    Enter your Email number to Login/Signup.
                  </p>
                  <div className="text-center">
                    <form>
                      <div className="custom-border my-1">
                        {/* <input
                        type="number"
                        className="form-control"
                        placeholder="Enter Your Mobile Number.."
                        value={value}
                        onChange={handleEmailChange}
                      /> */}
                        <PhoneInput
                          country={"us"}
                          placeholder="Enter phone number"
                          value={phoneNumber}
                          onChange={setPhoneNumber}
                        />
                      </div>
                      <div id="recaptcha-container"></div>
                      <div>
                        <button
                          onClick={handleSendOTP}
                          className="my-4 py-1 border-0 custom-border1 px-2"
                        >
                          Login with OTP{" "}
                          <i className="bi bi-arrow-right fs-6 fw-bold"></i>
                        </button>
                      </div>
                    </form>
                    <div className="text-center my-2 py-1">
                      <span className="text-muted">─────────</span>{" "}
                      <span className="mx-2">or</span>{" "}
                      <span className="text-muted">─────────</span>
                    </div>
                    <div className="img_google">
                      <button className="px-5 py-2">
                        <img
                          src={Google}
                          alt="googleee"
                          className="img-fluid px-2"
                        />
                        Google
                      </button>
                    </div>
                  </div>
                </>
              )}
            </div>

            <div className="row">
              <div className="col text-center">
                <p className="my-5 text-secondary">
                  By logging in, you're agreeing to our ?{" "}
                  <a href="#" className="text-secondary">
                    Privacy Policy.
                  </a>
                  <a href="#" className="text-secondary">
                    Terms of Service
                  </a>
                </p>
              </div>
            </div>
          </div>
          {/* end otp  */}
        </div>
      </div>
    </>
  );
};

export default Login;

























-------------------------------------------------------------------------------

import React, { useState, useEffect } from "react";
import {
  getFirestore,
  collection,
  getDocs,
  updateDoc,
  deleteDoc,
} from "firebase/firestore";
import Product_add from "../../Pages/SingleProduct/Product_add";
import Gpaypayment from "../../Pages/SingleProduct/Assets/secure-transaction.svg";
import Devlimg from "../../Pages/SingleProduct/Assets/delivery-sec.svg";
import Payment from "../../Pages/Payment/Payment";

const AddToCart = () => {
  const [cartProducts, setCartProducts] = useState([]);

  // Define fetchCartProducts outside of useEffect
  const fetchCartProducts = async () => {
    try {
      const firestore = getFirestore();
      const cartCollectionRef = collection(firestore, "addtocart");
      const querySnapshot = await getDocs(cartCollectionRef);

      const promises = [];
      const cartProducts = [];

      querySnapshot.forEach((doc) => {
        const subCollectionRef = collection(doc.ref, "products");
        const promise = getDocs(subCollectionRef).then(
          (subCollectionSnapshot) => {
            subCollectionSnapshot.forEach((subDoc) => {
              const data = subDoc.data();
              cartProducts.push({
                id: subDoc.id,
                data: data,
              });
            });
          }
        );
        promises.push(promise);
      });

      await Promise.all(promises);
      setCartProducts(cartProducts);
    } catch (error) {
      console.error("Error fetching cart products:", error);
    }
  };

  useEffect(() => {
    fetchCartProducts();
  }, []);

  const handleQuantityChange = async (productId, newQuantity) => {
    try {
      const firestore = getFirestore();
      const cartCollectionRef = collection(firestore, "addtocart");
      const querySnapshot = await getDocs(cartCollectionRef);

      querySnapshot.forEach(async (doc) => {
        const subCollectionRef = collection(doc.ref, "products");
        const subCollectionSnapshot = await getDocs(subCollectionRef);

        subCollectionSnapshot.forEach(async (subDoc) => {
          if (subDoc.id === productId) {
            await updateDoc(subDoc.ref, { itemCountcustomer: newQuantity });
            console.log("Item count updated successfully!");
            fetchCartProducts();
          }
        });
      });
    } catch (error) {
      console.error("Error updating item count:", error);
    }
  };

  const handleRemoveFromCart = async (productId) => {
    try {
      const firestore = getFirestore();
      const cartCollectionRef = collection(firestore, "addtocart");
      const querySnapshot = await getDocs(cartCollectionRef);

      querySnapshot.forEach(async (doc) => {
        const subCollectionRef = collection(doc.ref, "products");
        const subCollectionSnapshot = await getDocs(subCollectionRef);

        subCollectionSnapshot.forEach((subDoc) => {
          if (subDoc.id === productId) {
            // Delete the document from the subcollection
            deleteDoc(subDoc.ref)
              .then(() => {
                console.log("Document successfully deleted from cart!");
                // Fetch and display the updated cart products
                fetchCartProducts();
              })
              .catch((error) => {
                console.error("Error removing document: ", error);
              });
          }
        });
      });
    } catch (error) {
      console.error("Error removing product from cart: ", error);
    }
  };

  const calculateTotalPrice = (cartProducts) => {
    let totalPrice = 0;
    // Add a null check before calling forEach
    if (cartProducts) {
      cartProducts.forEach((cartProduct) => {
        const price = parseInt(cartProduct.data.price);
        const count = parseInt(cartProduct.data.itemCountcustomer);
        // console.log(count, "countcountcount");
        totalPrice += price * count;
      });
    }
    return totalPrice;
  };

  const totalCartPrice = calculateTotalPrice(cartProducts);

  return (
    <>
      <div className="conta">
        <div>
          {cartProducts.length > 0 ? (
            cartProducts &&
            cartProducts.map((cartProduct) => (
              <div className="map_function" key={cartProduct.id}>
                <div className="row align-items-center">
                  <div className="col-md-4">
                    <div className="addecardimg text-center">
                      <img
                        src={cartProduct.data.imageUrl}
                        alt="Addedeimg"
                        className="img-fluid"
                      />
                    </div>
                  </div>
                  <div className="col-md-8">
                    <div className="">
                      <h6 className="fw-bold d-flex justify-content-start ">
                        {cartProduct.data.name}
                      </h6>
                      <div className="d-flex ">
                        <i className="bi bi-currency-rupee fw-bold">
                          {cartProduct.data.price}
                        </i>{" "}
                        {"\u00a0"}
                        {"\u00a0"}
                        <span className="Success_color fw-bold fs-5">OFF</span>
                      </div>
                      <h6 className="fw-bold d-flex justify-content-start">
                        <span className="text-secondary">Color :</span>{" "}
                        {cartProduct.data.color}
                      </h6>
                      <h6 className="fw-bold d-flex justify-content-start">
                        <span className="text-secondary">Size :</span>{" "}
                        {cartProduct.data.sizecustomers}
                      </h6>
                      <p className="Success_color fs-6">
                        Lowest price in last 30 days
                      </p>
                      <div className="d-flex justify-content-between align-items-center">
                        <div style={{ marginTop: "-16px" }}>
                          <p className="text-muted fs-6">Quantity:</p>
                          <Product_add
                            initialQuantity={cartProduct.data.itemCountcustomer}
                            onQuantityChange={(newQuantity) =>
                              handleQuantityChange(cartProduct.id, newQuantity)
                            }
                          />
                        </div>
                        <div
                          className="font_size"
                          style={{ marginTop: "10px" }}
                        >
                          <button
                            className="btn btn-link border-0 fw-bold px-3 py-1 rounded-pill"
                            onClick={() => handleRemoveFromCart(cartProduct.id)}
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <hr />
              </div>
            ))
          ) : (
            <p className="fs-6 text-danger">No items in the cart</p>
          )}
        </div>

        <div className="col">
          <img src={Gpaypayment} alt="Gpaypayment" className="img-fluid" />
        </div>

        <div className="col">
          <h4 className="fw-bold fs-5">Order Summary :</h4>
          <div className="d-flex justify-content-between">
            <div className="fs-6">
              <p>Total MRP</p>
              <p>Bag Discount</p>
              <p>Coupon Discount</p>
              <p>Shipping Charge</p>
            </div>

            <div className="fs-6">
              <p>
                <i className="bi bi-currency-rupee"></i>
                {totalCartPrice}
              </p>
              <p>
                -<i className="bi bi-currency-rupee"></i>100
              </p>
              <p>
                <i className="bi bi-currency-rupee"></i>0.00
              </p>
              <p className="text-success fw-bold">Free</p>
            </div>
          </div>
          <hr />
          <div className="d-flex justify-content-between">
            <div>
              <h5 className="fw-bold">Total Payable </h5>
            </div>
            <div>
              <h5 className="fw-bold">
                <i className="bi bi-currency-rupee"></i>
                {totalCartPrice}
              </h5>
            </div>
          </div>
        </div>
        <div className="col my-4">
          <img src={Devlimg} alt="Devlimg" className="img-fluid" />
        </div>
        <div className="sticky-bottom bg-light p-3  shadow-lg rounded-pill w-100">
          <Payment cartProducts={cartProducts} />
        </div>
      </div>
    </>
  );
};

export default AddToCart;

